# ワークスペース アーキテクチャ原論 (workspace-architecture)

このドキュメントは、本ワークスペースの全体的な設計思想とコンセプトを網羅的に説明するものです。個別のツールのセットアップ手順やコマンドの詳細ではなく、「なぜこの構造になっているのか」「どのようにデータが流れるのか」といったアーキテクチャの原則に焦点を当てています。実際のセットアップ手順やツールの使用方法については `README.md` および各ツールのヘルプを参照してください。

## 1. 背景と設計目標 (Context & Goals)

現在、ワークスペースの資料管理において以下の課題が存在していました:
- ファイル共有にBOX、タスク管理にAsanaを使用する環境に統合したい
- 個人用ナレッジベースとしてObsidianを使用し、複数案件を繋げて統合管理したい
- 2台のPC間でシームレスに作業を同期したいが、ソースコード (Git) や各種ビルド生成ファイルはBOX同期から絶対に外したい
- AI (Claude Code等) との協働において、プロジェクトの前提や過去の文脈（コンテキスト）を維持する永続的な仕組みが必要

この目標を達成するため、本アーキテクチャでは **「情報の責務」に基づく3層レイヤー構造** と **AI用のコンテキスト圧縮層 (Context Compression Layer)** を導入しています。

---

## 2. コアコンセプト: 3層レイヤー構造による責務分離

物理的な配置ではなく、「情報の性質とライフサイクル」に基づいた3層構造を採用し、堅牢性と運用効率を両立させています。

| レイヤー | 役割 | ツール/保管場所 | データの性質 | Source of Truth |
| :--- | :--- | :--- | :--- | :--- |
| **Layer 1: Execution** | 実行・作業 | Local (`Documents/Projects/{案件}`) | Work in Progress (WIP)<br>揮発性が高い、速度とI/O優先 | Git / Asana / Local |
| **Layer 2: Knowledge** | 思考・知識 | BOX領域 (`Box/Obsidian-Vault`) | 相互リンクされた知識<br>文脈、経緯、知見、ドラフト | Obsidian Vault (Markdown) |
| **Layer 3: Artifact** | 成果物・参照 | BOX領域 (`Box/Projects/{案件}`) | ドキュメント、スナップショット、<br>PC間共有ファイル + 参照資料 | BOX / Local |

### 構造の統合機構: ジャンクションによる仮想マウント

これら3つの独立したレイヤーに散らばる情報へアクセスしやすくするため、作業の起点となる `Layer 1 (Local)` の直下に集約する手段として「ジャンクション (仮想リンク)」を利用します。これにより、ユーザーやAIエージェントからはすべてが1つのプロジェクトディレクトリ内に存在するように見えます。

1. `shared/` → `Box/Projects/{案件}` (Layer 3: 公式の成果物・参照ファイル)
2. `_ai-context/obsidian_notes/` → `Box/Obsidian-Vault/Projects/{案件}` (Layer 2: Obsidianナレッジ全量)
3. `_ai-context/context/` → `Box/Obsidian-Vault/Projects/{案件}/ai-context` (Layer 2: AIコンテキスト共有領域)
4. `external_shared/` → 複数の外部BOX共有フォルダへの各種ジャンクション群

---

## 3. 空間アーキテクチャ方針とフォルダ分類

- **ローカル専用領域とBOX同期領域の厳格な分離**:
  - `shared/` や `_ai-context/` 等のジャンクションの外側は「ローカル専用 (BOX非同期)」として扱います。（例：`development/source/` や `_ai-workspace/`）
  - ジャンクションを通じてアクセスする領域はすべて「BOX同期」であり、他PCやチームと自動的に同期・共有されます。
- **ドキュメントのライフサイクルによる分類 (Layer 3)**:
  - `docs/`: 企画・設計・テストなど、自らが作成・編集し、変化・成長していくドキュメント
  - `reference/`: 外部から提供される読むだけの資料（ベンダー仕様書、規約ファイルなど）
  - `records/`: スナップショットとして残す変更不可の記録（議事録、結果報告書、レビュー証跡など）
  - `_work/`: 日々の作業用スクラッチスペース。正式なドキュメント群に組み込まれる前の一時置き場・試行錯誤用ディレクトリ

---

## 4. Context Compression Layer (CCL) - AIとの協働基盤

AIコンテキストをセッションや時間を跨いで維持・管理するレイヤーです。AIエージェントが「今プロジェクトで何をすべきか」「過去に何が決まったか」を正確かつ瞬時に把握するための持続的な記憶基盤を提供します。

### CCLの責務と構成

AIエージェントはセッションが終了すると短期記憶（コンテキスト）を失うため、CCLが「プロジェクトの外部脳」として機能します。

- **`project_summary.md`**: プロジェクト全体像（長期的視点）
- **`current_focus.md`**: 直近のタスクと現在のフォーカス（短期的視点、人間とAIの双方向で更新する「今のスナップショット」）
- **`decision_log/`**: 意思決定履歴（背景・選択肢・理由を構造化したログ）
- **`memories/`**: プロジェクトメモリ（AIが自律的に発見・蓄積・検索する個別の知見ベース）

### カスタム AI SKILL による自律管理

CCLは単なる静的ファイル群の置き場ではありません。AI自身がプロアクティブにファイルを更新・維持するための拡張機能 (SKILL) によって支えられます。
- **context-decision-log**: 作業中に出た「会話上の暗黙的な決定（採用技術の選択など）」を検知し、構造化して記録を提案するスキル
- **context-session-end**: 作業セッションの終了時（会話の区切り）に、その日の進捗とAIが関与した作業結果を要約し `current_focus.md` に追記更新するスキル
- **project-memory**: エラーの原因追求やコードリーディングを通じてAIが得た知見を、後日再利用できるようタグ付けして保存・検索するスキル

---

## 5. Multi-CLI アーキテクチャ

複数のAI CLIエージェント (Claude Code, Codex CLI, Gemini CLI 等) が混在する環境下でも、コンテキストを一本化・集約する仕組みです。

- **指示のSingle Source of Truth**:
  - マスターとなるプロジェクト指示書は `shared/AGENTS.md` (Layer 3) 1つのみに厳選し、BOX経由でPC間同期させます。
- **各種CLIへのAliasマッピング**:
  - 各CLIツールが要求する固有のファイル名 (`CLAUDE.md` など) に対して、マスターの `AGENTS.md` のファイルをローカルへコピーして（またはリンクとして）配置します。これにより、どのツールを使用しても同一の指示とコンテキスト(CCL)を参照する構造を確立しています。

---

## 6. プロジェクト規模の階層化 (Tier Architecture)

案件の性質や規模に応じて、構成ファイルの煩雑さやオーバーヘッドを最小化するために2つのTier(階層)を設けています。

| コンポーネント | Full Tier (メイン案件) | Mini Tier (お手伝い系・小規模) |
| :--- | :--- | :--- |
| **ユースケース** | 長期、複雑、ドキュメント重視 | 短期、シンプル、ファイル数が少ない |
| **Layer 3 (Artifact)** | 構造化 (`docs/planning`, `reference/` 等) | フラット構造 (`docs/` のみ) |
| **Layer 2 (Knowledge)** | `daily/`, `meetings/`, `specs/` と細分化 | `notes/` フォルダのみ |
| **Layer 1 (Local)** | AI作業用 (`_ai-workspace/`) を含むフル機能 | 開発(`development/`)と最小構成 |
| **CCL** | 全機能セットアップ | `current_focus.md` などの最小構成に縮退可能 |

※ プロジェクトの成長に合わせて、Mini Tier から Full Tier への変換 (Tier Promotion) がツールによってサポートされます。

---

## 7. ライフサイクル管理 (アーカイブによるノイズ排除)

プロジェクトが終了した後も、蓄積したコンテキストを将来に活かしつつ、日常の検索ノイズを減らすため「アーカイブ機構」を組み込んでいます。

1. **アクティブ領域とアーカイブ領域の分離**:
   - 完了プロジェクトは削除されることなく、ローカル(Layer 1)、Obsidian Vault(Layer 2)、BOX(Layer 3) のそれぞれで専用の `_archive/` フォルダへと移行されます。
2. **プロジェクト固有ジャンクションの解除**:
   - 不要なストレージアクセスや、AIの過剰なファイルインデックス生成を防ぐため、アーカイブ時には `shared/` などのジャンクションは直ちに解除されます。
3. **ナレッジの抽出 (Knowledge Promotion)**:
   - アーカイブの評価プロセスにおいて、特定のプロジェクトに依存しない汎用的な技術知見は、Obsidian Vault の `TechNotes/` (案件横断・汎用技術領域) に昇格させます。

---

## 8. アーキテクチャ上の制約と軽減策

本ワークスペースはいくつかの仕組みの制約の上に成り立っています。

1. **BOX同期とObsidian設定の競合リスク**:
   - `Layer 2` におけるObsidianの設定ディレクトリ(`.obsidian/`)もあわせて同期されます。2台のPCでObsidianを同時に編集すると設定やプラグインデータが競合・破損する可能性が高まるため、「2PCでの同時起動は行わない」運用ルールを前提とします。
2. **Git領域の実態とデータ保護**:
   - ソースコード関連 (`development/source/` 以下) は絶対にBOX同期対象（`shared/`等）以下には配置しません。BOX側に`.git/` が同期されることによるインデックス破損リスクと、大量の一時ビルドファイルのクラウドアップロードを阻止するため、これらはすべて純粋なローカルディレクトリ内に配置されます。
3. **ジャンクションのボリューム制限**:
   - Windowsのジャンクション機能は「同一ドライブ（ボリューム）内」でのみ有効です。本アーキテクチャでは `%USERPROFILE%\Documents` (ローカル領域) と `%USERPROFILE%\Box` (BOXドライブ領域) が共に同一システムドライブ(C:)内に存在することを前提として設計されています。
4. **BOX特有のシンボリックリンク非対応への対処**:
   - BOXはシンボリックリンク (`.lnk`や環境固有ショートカット) を同期しません（無視されるか実体ファイルとして再計算されます）。共有領域内にシンボリックリンクが必要な場合は、各PCごとにローカル領域でマウント・再生成する（スクリプトに組み込む）等で解決しています。
